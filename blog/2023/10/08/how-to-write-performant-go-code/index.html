<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.111.3"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>How To Write Performant Go Code | Findy Agency</title><meta name=description content="The Go programming language has an excellent [concurrency model](https://findy-network.github.io/blog/2023/06/22/beautiful-state-machines-fsm-part-ii/) that offers great potential to utilize the power of multi-core CPUs. First, we need to understand the basics of the single CPU core for the overall software performance. For instance, you can write readable and more performant code when you know how compilers and underlying hardware work and you use **multi-discipline engineering practices**."><meta property="og:title" content="How To Write Performant Go Code"><meta property="og:description" content="The Go programming language has an excellent [concurrency model](https://findy-network.github.io/blog/2023/06/22/beautiful-state-machines-fsm-part-ii/) that offers great potential to utilize the power of multi-core CPUs. First, we need to understand the basics of the single CPU core for the overall software performance. For instance, you can write readable and more performant code when you know how compilers and underlying hardware work and you use **multi-discipline engineering practices**."><meta property="og:type" content="article"><meta property="og:url" content="/blog/2023/10/08/how-to-write-performant-go-code/"><meta property="og:image" content="/blog/2023/10/08/how-to-write-performant-go-code/cover.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-10-08T00:00:00+00:00"><meta property="article:modified_time" content="2023-10-08T00:00:00+00:00"><meta property="og:site_name" content="Findy Agency"><meta itemprop=name content="How To Write Performant Go Code"><meta itemprop=description content="The Go programming language has an excellent [concurrency model](https://findy-network.github.io/blog/2023/06/22/beautiful-state-machines-fsm-part-ii/) that offers great potential to utilize the power of multi-core CPUs. First, we need to understand the basics of the single CPU core for the overall software performance. For instance, you can write readable and more performant code when you know how compilers and underlying hardware work and you use **multi-discipline engineering practices**."><meta itemprop=datePublished content="2023-10-08T00:00:00+00:00"><meta itemprop=dateModified content="2023-10-08T00:00:00+00:00"><meta itemprop=wordCount content="1701"><meta itemprop=image content="/blog/2023/10/08/how-to-write-performant-go-code/cover.png"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/blog/2023/10/08/how-to-write-performant-go-code/cover.png"><meta name=twitter:title content="How To Write Performant Go Code"><meta name=twitter:description content="The Go programming language has an excellent [concurrency model](https://findy-network.github.io/blog/2023/06/22/beautiful-state-machines-fsm-part-ii/) that offers great potential to utilize the power of multi-core CPUs. First, we need to understand the basics of the single CPU core for the overall software performance. For instance, you can write readable and more performant code when you know how compilers and underlying hardware work and you use **multi-discipline engineering practices**."><link rel=preload href=/scss/main.min.fe387f54b6718948c0bf2601ff90a4fd03ef4cc0f5b2a71235d60ec478692d2d.css as=style><link href=/scss/main.min.fe387f54b6718948c0bf2601ff90a4fd03ef4cc0f5b2a71235d60ec478692d2d.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Findy Agency</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>Blog</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ title="Findy Agency Blog" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>Blog</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blog20231008how-to-write-performant-go-code-li><a href=/blog/2023/10/08/how-to-write-performant-go-code/ title="How To Write Performant Go Code" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-blog20231008how-to-write-performant-go-code><span class=td-sidebar-nav-active-item>Performant Go Code</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230823gophercon-uk-2023-li><a href=/blog/2023/08/23/gophercon-uk-2023/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230823gophercon-uk-2023><span>GopherCon UK 2023</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230622beautiful-state-machines-fsm-part-ii-li><a href=/blog/2023/06/22/beautiful-state-machines-fsm-part-ii/ title="Beautiful State-Machines - FSM Part II" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230622beautiful-state-machines-fsm-part-ii><span>Beautiful State-Machines</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230613the-agency-workshop-li><a href=/blog/2023/06/13/the-agency-workshop/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230613the-agency-workshop><span>The Agency Workshop</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230609the-time-to-build-ssi-capabilities-is-now-li><a href=/blog/2023/06/09/the-time-to-build-ssi-capabilities-is-now/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230609the-time-to-build-ssi-capabilities-is-now><span>The Time to Build SSI Capabilities Is Now</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230525digital-identity-hack-part-3-introduction-to-ssi-presentation-li><a href=/blog/2023/05/25/digital-identity-hack-part-3-introduction-to-ssi-presentation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230525digital-identity-hack-part-3-introduction-to-ssi-presentation><span>Digital Identity Hack Part 3 – Introduction to SSI Presentation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230523digital-identity-hack-part-2-panel-discussion-on-blockchain-projects-li><a href=/blog/2023/05/23/digital-identity-hack-part-2-panel-discussion-on-blockchain-projects/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230523digital-identity-hack-part-2-panel-discussion-on-blockchain-projects><span>Digital Identity Hack Part 2 – Panel Discussion on Blockchain Projects</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230511digital-identity-hack-unlocking-the-potential-of-ssi-li><a href=/blog/2023/05/11/digital-identity-hack-unlocking-the-potential-of-ssi/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230511digital-identity-hack-unlocking-the-potential-of-ssi><span>Digital Identity Hack – Unlocking the Potential of SSI</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230508deploying-with-cdk-pipeline-li><a href=/blog/2023/05/08/deploying-with-cdk-pipeline/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230508deploying-with-cdk-pipeline><span>Deploying with CDK Pipeline</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230425agencys-iac-journey-li><a href=/blog/2023/04/25/agencys-iac-journey/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230425agencys-iac-journey><span>Agency's IaC Journey</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230313no-code-ssi-chatbots-fsm-part-i-li><a href=/blog/2023/03/13/no-code-ssi-chatbots-fsm-part-i/ title="No-Code SSI Chatbots - FSM Part I" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230313no-code-ssi-chatbots-fsm-part-i><span>No-Code SSI Chatbots</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230206how-to-equip-your-app-with-vc-superpowers-li><a href=/blog/2023/02/06/how-to-equip-your-app-with-vc-superpowers/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230206how-to-equip-your-app-with-vc-superpowers><span>How to Equip Your App with VC Superpowers</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230130getting-started-with-ssi-service-agent-development-li><a href=/blog/2023/01/30/getting-started-with-ssi-service-agent-development/ title="Getting Started with SSI Service Agent Development " class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230130getting-started-with-ssi-service-agent-development><span>Getting Started with SSI Service Agent Development</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220930ledger-multiplexer-li><a href=/blog/2022/09/30/ledger-multiplexer/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220930ledger-multiplexer><span>Ledger Multiplexer</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220927the-hyperledger-global-forum-experience-li><a href=/blog/2022/09/27/the-hyperledger-global-forum-experience/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220927the-hyperledger-global-forum-experience><span>The Hyperledger Global Forum Experience</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220829the-findy-agency-api-li><a href=/blog/2022/08/29/the-findy-agency-api/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220829the-findy-agency-api><span>The Findy Agency API</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220427trust-in-your-wallet-li><a href=/blog/2022/04/27/trust-in-your-wallet/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220427trust-in-your-wallet><span>Trust in Your Wallet</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220407ssi-empowered-identity-provider-li><a href=/blog/2022/04/07/ssi-empowered-identity-provider/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220407ssi-empowered-identity-provider><span>SSI-Empowered Identity Provider</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220314replacing-indy-sdk-li><a href=/blog/2022/03/14/replacing-indy-sdk/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220314replacing-indy-sdk><span>Replacing Indy SDK</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220305the-missing-network-layer-model-li><a href=/blog/2022/03/05/the-missing-network-layer-model/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220305the-missing-network-layer-model><span>The Missing Network Layer Model</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220119fostering-interoperability-li><a href=/blog/2022/01/19/fostering-interoperability/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220119fostering-interoperability><span>Fostering Interoperability</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211109anchoring-chains-of-trust-li><a href=/blog/2021/11/09/anchoring-chains-of-trust/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211109anchoring-chains-of-trust><span>Anchoring Chains of Trust</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210920the-arm-adventure-on-docker-li><a href=/blog/2021/09/20/the-arm-adventure-on-docker/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210920the-arm-adventure-on-docker><span>The Arm Adventure on Docker</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210908travelogue-li><a href=/blog/2021/09/08/travelogue/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210908travelogue><span>Travelogue</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210811announcing-findy-agency-li><a href=/blog/2021/08/11/announcing-findy-agency/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210811announcing-findy-agency><span>Announcing Findy Agency</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a id=print href=/blog/_print/><i class="fa-solid fa-print fa-fw"></i> Print entire section</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#performance-rules>Performance Rules</a><ul><li><a href=#function-inlining>Function Inlining</a></li><li><a href=#memory-allocations>Memory Allocations</a></li><li><a href=#how-dynamic-are-the-inputs>How Dynamic Are The Inputs?</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><a class=td-rss-button title=RSS href=/blog/index.xml target=_blank rel=noopener><i class="fa-solid fa-rss" aria-hidden=true></i></a><div class=td-content><h1>How To Write Performant Go Code</h1><div class=lead>The Go programming language has an excellent <a href=https://findy-network.github.io/blog/2023/06/22/beautiful-state-machines-fsm-part-ii/>concurrency model</a> that offers great potential to utilize the power of multi-core CPUs. First, we need to understand the basics of the single CPU core for the overall software performance. For instance, you can write readable and more performant code when you know how compilers and underlying hardware work and you use <strong>multi-discipline engineering practices</strong>.</div><div class="td-byline mb-4">By <b>Harri Lainio</b> |
<time datetime=2023-10-08 class=text-muted>Sunday, October 08, 2023</time></div><header class=article-meta></header><p>I suppose all of us programmers have heard of the infamous <em>premature optimization</em>:</p><blockquote><p><em>Premature optimization is the root of all evil in programming.</em></p></blockquote><p>Really? I don&rsquo;t think so.</p><p>The full quote from the must-read <em>The Art of Computer Programming by
Donald Knuth</em>:</p><blockquote><p><em>The real problem is that programmers have spent far too much time worrying
about efficiency in the wrong places and at the wrong times; premature
optimization is the root of all evil (or at least most of it) in programming.</em></p></blockquote><p>Like so many pearls of wisdom, they are a child of their own time.
They are usually dangerously separated from their context to underline the
message the next author wants to emphasize their statement. I believe most of us
have only read the shortened, i.e., <em>wrong</em> version of the quotation.</p><p>I claim that if <strong>keeping performance is your second nature, it’ll not ruin the
other quality attributes of your code, but the opposite</strong>. All you need to do is
to follow some basic rules with your muscle memory.</p><h2 id=performance-rules>Performance Rules</h2><p>In this post, I concentrate only on these three:</p><ol><li><strong>A function call is computationally expensive</strong> if the compiler cannot
<a href=https://en.wikipedia.org/wiki/Inline_expansion>inline expanse</a> it, i.e. do
function inlining. When inlining, the compiler produce machine code, that
doesn&rsquo;t include real sub-routine calls with argument transportation either
stack or CPU registers, and unwinding the stack and copy results to desired
memory locations after the call returns. With function inlining you can think
that the compiler copy/paste your function&rsquo;s machine instructions to all of
those places where it&rsquo;s called.</li><li><strong>Heap allocations are computationally expensive</strong>. (We out-scope garbage
collection algorithms because they&rsquo;re such a significant topic that even one
book is insufficient. Still, it&rsquo;s good to know that heap allocation
<a href=https://www.jetbrains.com/help/dotmemory/Analysis_Overview_Page.html#high-gc-pressure>pressurize a garbage
collector</a>.)</li><li><strong>Minimize the problem space at every level of abstraction</strong> and the need
for variables, i.e. especially in inner loops. Consider what <em>parts of
inputs are really varying and what parts are constant</em>. For example, think
twice if you need <code>regex</code> inside of your program.</li></ol><h3 id=function-inlining>Function Inlining</h3><p>Let&rsquo;s write our version of the famous <code>assert</code> function to show how function
inlining can help readability outside of the tests without sacrificing
performance.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>assert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>term</span> <span style=color:#204a87;font-weight:700>bool</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>msg</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>term</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>doSomething</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#000>any</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>b</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>assert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;interface value cannot be nil&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>assert</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;byte slice cannot be empty (or nil)&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// continue with something important
</span></span></span></code></pre></div><p>By writing the benchmark function for <code>assert</code> with Go&rsquo;s testing capabilities,
you can measure the &lsquo;weight&rsquo; of the function itself. You get the comparison
point by writing the reference benchmark where you have manually inline-expansed
the function, i.e. by hand. It would look like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>doSomethingNoAssert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#000>any</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>b</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// for benchmarks only
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;interface value cannot be nil&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;byte slice cannot be empty (or nil)&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// continue with something important
</span></span></span></code></pre></div><p>Note, this would be your reference point only. (I&rsquo;ll show how to turn off
inlining with Go compiler flags, which would work as a good benchmarking
reference for some cases.)</p><p>And, if you aren&rsquo;t interested in the actual performance figures but just the
information about successful inline expansion done by the compiler, you can ask:</p><pre tabindex=0><code>go test -c -gcflags=-m=2 &lt;PKG_NAME&gt; 2&gt;&amp;1 | grep &#39;inlin&#39;
</code></pre><p>The <code>-gcflags=-m=2</code> gives lots of information, but we can filter only those
lines that contain messages considering the inlining. Depending on the size of
the packages there can be an overwhelming lot of information where most of them
aren&rsquo;t related to the task in your hand. You can always filter more.</p><p>The <code>-gcflags</code> will be your programming buddy in the future. To get more
information about the flags, run:</p><pre tabindex=0><code>go build -gcflags -help
</code></pre><p>Naturally, you can use compiler to give you a reference point for your inline
optimizations as I said before.</p><p>Disable all optimizations:</p><pre tabindex=0><code>go test -gcflags=&#39;-N&#39; -bench=&#39;.&#39; &lt;PKG_NAME&gt;
</code></pre><p>Disable inlining:</p><pre tabindex=0><code>go test -gcflags &#39;-l&#39; -bench=&#39;.&#39; &lt;PKG_NAME&gt;
</code></pre><h3 id=memory-allocations>Memory Allocations</h3><p>Similarly, as function calls, the memory allocations from the heap are
expensive. It’s good practice to prevent unnecessary allocations even when the
programming platform has a garbage collector. With the Go, it’s essential to
understand the basics of memory management principles Go uses because of memory
locality, i.e., it has pointers and value types. Many other garbage-collected
languages have object references, and the <a href="https://www.youtube.com/watch?v=bmZNaUcwBt4&amp;t=1626s">memory
locality</a> is hidden from
the programmer, leading to poor performance, e.g., cache misses.</p><p>But nothing comes for free—you need to know what you’re doing. Go’s compiler
analyzes your code and, without your help, can decide if a variable is <em>escaping</em>
from its scope and needs to be moved from a stack to the heap.</p><p>Go’s tools give you extra information about <a href=https://appliedgo.com/blog/how-to-do-escape-analysis>escape
analyzes</a>. Use the
<code>-gcflags=-m=2</code> again, but <code>grep</code> <em>escape</em> lines from the output. That will tell
you exactly what’s going on with the pointers for every function in the current
compilation.</p><p>Usually, when benchmarking Go code, it’s good to understand what’s going on with
heap allocations. Just add the following argument e.g., your test benchmark
compilation, and you get the statistics of allocations in the benchmark run.</p><pre tabindex=0><code>go test -benchmem -bench=. &lt;PKG_NAME&gt;
</code></pre><p>The <code>-benchmem</code> flag inserts two columns to benchmarking results:</p><figure class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:1000px><img class=card-img-top src=/blog/2023/10/08/how-to-write-performant-go-code/first-bench_hu98d22a50750084df68633ff7a85ec502_50678_990x0_resize_catmullrom_3.png width=990 height=199><figcaption class="card-body px-0 pt-2 pb-0"><p class=card-text><em>Benching Memory Allocations</em></p></figcaption></figure><p>Please note that five (5) columns are now instead of standard three. The extra
two (rightmost and marked with red rectangle) are the about memory allocations.
<code>B/op</code> is the average amount of bytes per memory allocation in the rightmost
column <code>allocs/op.</code></p><p>Fewer allocations, and the smaller the size of the allocations, the better. Please
note that the performance difference between the above benchmark results isn’t
because of the allocations only. Most of the differences will be explained in
the following chapters. But still, allocations are something you should be aware
of, especially about the variable escaping if it leads to heap allocations.</p><h3 id=how-dynamic-are-the-inputs>How Dynamic Are The Inputs?</h3><p>How much do the variables in your program change, or maybe they are constant?
Naturally, <strong>the smaller the actual input set of the function, the better chance
we have to optimize</strong> its performance because the more deterministic the solution
will be. Also, smaller machine code performs better in modern memory-bound CPUs.
The same cache rules apply to instructions as variables. CPU doesn’t need to
access RAM if all the required code is already in the CPU.</p><p>The above benchmark results are from two functions that do the same thing. This
is the regex version of it (first row in the benchmark results):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>	<span style=color:#000>uncamel</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>regexp</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MustCompile</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>`([A-Z]+)`</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#000>clean</span>   <span style=color:#000;font-weight:700>=</span> <span style=color:#000>regexp</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MustCompile</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>`[^\w]`</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// DecamelRegexp return the given string as space delimeted. Note! it&#39;s slow. Use
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Decamel instead.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>DecamelRegexp</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>str</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#000>str</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>clean</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ReplaceAllString</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>str</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34; &#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#000>str</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>uncamel</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ReplaceAllString</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>str</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>` $1`</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#000>str</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>strings</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Trim</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>str</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34; &#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#000>str</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>strings</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ToLower</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>str</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>str</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Go’s regex implementation is known to be relatively slow, but if you think that
regex needs its compiler and processor, it’s not so surprising.</p><p>The hand-optimized version of the Decamel function is almost ten times faster.
It sounds pretty much like it’s natural because we don’t need all the
versatility of the entire regex. We need to transform the inputted CamelCase
string to a standard lowercase string. However the input strings aren’t without
some exceptions in our use case because they come from the Go compiler itself.
(The inputs are from Go&rsquo;s stack trace.) And still, the input set is small enough
that we quickly see the difference. And now, <strong>we can shrink the problem space
to our specific needs.</strong></p><p>The 1000%-faster version of Decamel that’s still quite readable:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>Decamel</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>     <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>          <span style=color:#000>b</span>           <span style=color:#000>strings</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Builder</span>
</span></span><span style=display:flex><span>          <span style=color:#000>splittable</span>  <span style=color:#204a87;font-weight:700>bool</span>
</span></span><span style=display:flex><span>          <span style=color:#000>isUpper</span>     <span style=color:#204a87;font-weight:700>bool</span>
</span></span><span style=display:flex><span>          <span style=color:#000>prevSkipped</span> <span style=color:#204a87;font-weight:700>bool</span>
</span></span><span style=display:flex><span>     <span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>     <span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Grow</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>range</span> <span style=color:#000>s</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>skip</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;(&#39;</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;)&#39;</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;*&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>skip</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>prevSkipped</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// first time write space
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WriteRune</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39; &#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>               <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>               <span style=color:#000>prevSkipped</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>skip</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>continue</span>
</span></span><span style=display:flex><span>          <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>          <span style=color:#000>toSpace</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;.&#39;</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;_&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>toSpace</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>prevSkipped</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>continue</span>
</span></span><span style=display:flex><span>               <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;.&#39;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WriteRune</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;:&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>               <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>               <span style=color:#000>v</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#39; &#39;</span>
</span></span><span style=display:flex><span>               <span style=color:#000>prevSkipped</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>          <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>               <span style=color:#000>isUpper</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>unicode</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>IsUpper</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>isUpper</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>v</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>unicode</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ToLower</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>prevSkipped</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>splittable</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                         <span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WriteRune</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39; &#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                         <span style=color:#000>prevSkipped</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>               <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>prevSkipped</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span>               <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>          <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>          <span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WriteRune</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#000>splittable</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>isUpper</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>unicode</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>IsNumber</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>     <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>     <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>String</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Let’s take another example where results are even more drastically faster, but
the reason is precisely the same. The input set is much smaller than what the
first implementation function is meant to be used.</p><p>The results:</p><figure class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:1000px><img class=card-img-top src=/blog/2023/10/08/how-to-write-performant-go-code/second-bench_hueefa9a04342b4e4346aac56c90d0563e_36897_990x0_resize_catmullrom_3.png width=990 height=180><figcaption class="card-body px-0 pt-2 pb-0"><p class=card-text><em>Benching Get Goroutine ID</em></p></figcaption></figure><p>The first implementation:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>oldGoid</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buf</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>     <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Fscanf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewReader</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#34;goroutine %d&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>     <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cannot get goroutine id: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span>     <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>     <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>id</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>The above code is quite self explanatory, and that&rsquo;s very good.</p><p>The second and <del>faster</del><em>fastest</em> implementation:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>asciiWordToInt</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>     <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>     <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ch</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>range</span> <span style=color:#000>b</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>ch</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39; &#39;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>break</span>
</span></span><span style=display:flex><span>          <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>          <span style=color:#000>ch</span> <span style=color:#ce5c00;font-weight:700>-=</span> <span style=color:#4e9a06>&#39;0&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>ch</span> <span style=color:#000;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>9</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;character isn&#39;t number&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>          <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>          <span style=color:#000>n</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>10</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ch</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>     <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>     <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>n</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>These two functions do precisely the same thing, or should I say almost because
the latter’s API is more <em>generic</em>. (In a way, we are both narrowing and
widening the scope simultaneously, huh?) The converted integer must start from
the first byte in the slice of ASCII bytes.</p><p>It is much over 100x faster! Ten thousand percent. Why?</p><p>Because the only thing we need is to process the ASCII string that comes in as a
byte slice.</p><blockquote><p>You might ask whether this ruined the <em>readability</em>, which is fair. But no,
because the function <code>asciiWordToInt</code> is called from <code>GoroutineID</code>, which is
just enough—trust abstraction layering. (See the rule #1.)</p></blockquote><p>Next time you are writing something, think twice—I do 😉</p><h1 id=ps>P.S.</h1><p>There is so much more about performance tuning in Go. This piece was just a
scratch of the surface. If you are interested in the topic, please get in touch
with our project team, and we will tell you more. We would be delighted if you
join our effort to develop the fastest identity agency.</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2023/08/23/gophercon-uk-2023/ aria-label="Previous - GopherCon UK 2023" class="btn btn-primary"><span class=mr-1>←</span>Previous</a></li><li><a class="btn btn-primary disabled">Next<span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/findy-network aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Findy Agency Authors All Rights Reserved</small><p class=mt-2><a href=/about/>About Findy Agency</a></p></div></div></div></footer></div><script src=/js/deflate.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.css integrity="sha512-6VMVcy7XQNyarhVuiL50FzpgCFKsyTd6YO93aaQEyET+BNaWvj0IgKR86Bf6+AmWczxAcSnL+JGjo+iStgO1gQ==" crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.js integrity="sha512-b9IKj4LCNrtCPBhceRcoYOHWW/S2q9fpl7iAJlyxYpykRj1SKM7FE9+E0NEnJ8g8ni47LBr2GuX9qzg/xeuwzQ==" crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/contrib/auto-render.min.js integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg==" crossorigin=anonymous onload=renderMathInElement(document.body,null)></script><script src=https://cdn.jsdelivr.net/npm/mermaid@9.2.2/dist/mermaid.min.js integrity="sha512-IX+bU+wShHqfqaMHLMrtwi4nK6W/Z+QdZoL4kPNtRxI2wCLyHPMAdl3a43Fv1Foqv4AP+aiW6hg1dcrTt3xc+Q==" crossorigin=anonymous></script>
<script src=/js/main.min.5f9fb113d757687f050fa88e558cf3550134dff65d578b2a707553d35161ea6a.js integrity="sha256-X5+xE9dXaH8FD6iOVYzzVQE03/ZdV4sqcHVT01Fh6mo=" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script></body></html>