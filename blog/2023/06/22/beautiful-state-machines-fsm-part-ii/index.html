<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.111.3"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Beautiful State-Machines - FSM Part II | Findy Agency</title><meta name=description content="In today’s software development landscape, efficient and robust state management systems are more critical than ever. Finite state machines (FSMs), together with Go’s Communicating Sequential Processes (CSP) concurrency mechanism, we can provide a robust and elegant approach to modeling and controlling complex systems with discrete states and transitions."><meta property="og:title" content="Beautiful State-Machines - FSM Part II"><meta property="og:description" content="In today’s software development landscape, efficient and robust state management systems are more critical than ever. Finite state machines (FSMs), together with Go’s Communicating Sequential Processes (CSP) concurrency mechanism, we can provide a robust and elegant approach to modeling and controlling complex systems with discrete states and transitions."><meta property="og:type" content="article"><meta property="og:url" content="/blog/2023/06/22/beautiful-state-machines-fsm-part-ii/"><meta property="og:image" content="/blog/2023/06/22/beautiful-state-machines-fsm-part-ii/cover-logical.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-06-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-06-22T00:00:00+00:00"><meta property="og:site_name" content="Findy Agency"><meta itemprop=name content="Beautiful State-Machines - FSM Part II"><meta itemprop=description content="In today’s software development landscape, efficient and robust state management systems are more critical than ever. Finite state machines (FSMs), together with Go’s Communicating Sequential Processes (CSP) concurrency mechanism, we can provide a robust and elegant approach to modeling and controlling complex systems with discrete states and transitions."><meta itemprop=datePublished content="2023-06-22T00:00:00+00:00"><meta itemprop=dateModified content="2023-06-22T00:00:00+00:00"><meta itemprop=wordCount content="2211"><meta itemprop=image content="/blog/2023/06/22/beautiful-state-machines-fsm-part-ii/cover-logical.png"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/blog/2023/06/22/beautiful-state-machines-fsm-part-ii/cover-logical.png"><meta name=twitter:title content="Beautiful State-Machines - FSM Part II"><meta name=twitter:description content="In today’s software development landscape, efficient and robust state management systems are more critical than ever. Finite state machines (FSMs), together with Go’s Communicating Sequential Processes (CSP) concurrency mechanism, we can provide a robust and elegant approach to modeling and controlling complex systems with discrete states and transitions."><link rel=preload href=/scss/main.min.fe387f54b6718948c0bf2601ff90a4fd03ef4cc0f5b2a71235d60ec478692d2d.css as=style><link href=/scss/main.min.fe387f54b6718948c0bf2601ff90a4fd03ef4cc0f5b2a71235d60ec478692d2d.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Findy Agency</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>Blog</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ title="Findy Agency Blog" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>Blog</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20231022how-to-write-modifiable-readable-go-code-li><a href=/blog/2023/10/22/how-to-write-modifiable-readable-go-code/ title="How To Write Modifiable & Readable Go Code" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20231022how-to-write-modifiable-readable-go-code><span>Quality Go Code</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20231008how-to-write-performant-go-code-li><a href=/blog/2023/10/08/how-to-write-performant-go-code/ title="How To Write Performant Go Code" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20231008how-to-write-performant-go-code><span>Performant Go Code</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230823gophercon-uk-2023-li><a href=/blog/2023/08/23/gophercon-uk-2023/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230823gophercon-uk-2023><span>GopherCon UK 2023</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blog20230622beautiful-state-machines-fsm-part-ii-li><a href=/blog/2023/06/22/beautiful-state-machines-fsm-part-ii/ title="Beautiful State-Machines - FSM Part II" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-blog20230622beautiful-state-machines-fsm-part-ii><span class=td-sidebar-nav-active-item>Beautiful State-Machines</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230613the-agency-workshop-li><a href=/blog/2023/06/13/the-agency-workshop/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230613the-agency-workshop><span>The Agency Workshop</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230609the-time-to-build-ssi-capabilities-is-now-li><a href=/blog/2023/06/09/the-time-to-build-ssi-capabilities-is-now/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230609the-time-to-build-ssi-capabilities-is-now><span>The Time to Build SSI Capabilities Is Now</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230525digital-identity-hack-part-3-introduction-to-ssi-presentation-li><a href=/blog/2023/05/25/digital-identity-hack-part-3-introduction-to-ssi-presentation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230525digital-identity-hack-part-3-introduction-to-ssi-presentation><span>Digital Identity Hack Part 3 – Introduction to SSI Presentation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230523digital-identity-hack-part-2-panel-discussion-on-blockchain-projects-li><a href=/blog/2023/05/23/digital-identity-hack-part-2-panel-discussion-on-blockchain-projects/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230523digital-identity-hack-part-2-panel-discussion-on-blockchain-projects><span>Digital Identity Hack Part 2 – Panel Discussion on Blockchain Projects</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230511digital-identity-hack-unlocking-the-potential-of-ssi-li><a href=/blog/2023/05/11/digital-identity-hack-unlocking-the-potential-of-ssi/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230511digital-identity-hack-unlocking-the-potential-of-ssi><span>Digital Identity Hack – Unlocking the Potential of SSI</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230508deploying-with-cdk-pipeline-li><a href=/blog/2023/05/08/deploying-with-cdk-pipeline/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230508deploying-with-cdk-pipeline><span>Deploying with CDK Pipeline</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230425agencys-iac-journey-li><a href=/blog/2023/04/25/agencys-iac-journey/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230425agencys-iac-journey><span>Agency's IaC Journey</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230313no-code-ssi-chatbots-fsm-part-i-li><a href=/blog/2023/03/13/no-code-ssi-chatbots-fsm-part-i/ title="No-Code SSI Chatbots - FSM Part I" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230313no-code-ssi-chatbots-fsm-part-i><span>No-Code SSI Chatbots</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230206how-to-equip-your-app-with-vc-superpowers-li><a href=/blog/2023/02/06/how-to-equip-your-app-with-vc-superpowers/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230206how-to-equip-your-app-with-vc-superpowers><span>How to Equip Your App with VC Superpowers</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230130getting-started-with-ssi-service-agent-development-li><a href=/blog/2023/01/30/getting-started-with-ssi-service-agent-development/ title="Getting Started with SSI Service Agent Development " class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230130getting-started-with-ssi-service-agent-development><span>Getting Started with SSI Service Agent Development</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220930ledger-multiplexer-li><a href=/blog/2022/09/30/ledger-multiplexer/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220930ledger-multiplexer><span>Ledger Multiplexer</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220927the-hyperledger-global-forum-experience-li><a href=/blog/2022/09/27/the-hyperledger-global-forum-experience/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220927the-hyperledger-global-forum-experience><span>The Hyperledger Global Forum Experience</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220829the-findy-agency-api-li><a href=/blog/2022/08/29/the-findy-agency-api/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220829the-findy-agency-api><span>The Findy Agency API</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220427trust-in-your-wallet-li><a href=/blog/2022/04/27/trust-in-your-wallet/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220427trust-in-your-wallet><span>Trust in Your Wallet</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220407ssi-empowered-identity-provider-li><a href=/blog/2022/04/07/ssi-empowered-identity-provider/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220407ssi-empowered-identity-provider><span>SSI-Empowered Identity Provider</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220314replacing-indy-sdk-li><a href=/blog/2022/03/14/replacing-indy-sdk/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220314replacing-indy-sdk><span>Replacing Indy SDK</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220305the-missing-network-layer-model-li><a href=/blog/2022/03/05/the-missing-network-layer-model/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220305the-missing-network-layer-model><span>The Missing Network Layer Model</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220119fostering-interoperability-li><a href=/blog/2022/01/19/fostering-interoperability/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220119fostering-interoperability><span>Fostering Interoperability</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211109anchoring-chains-of-trust-li><a href=/blog/2021/11/09/anchoring-chains-of-trust/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211109anchoring-chains-of-trust><span>Anchoring Chains of Trust</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210920the-arm-adventure-on-docker-li><a href=/blog/2021/09/20/the-arm-adventure-on-docker/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210920the-arm-adventure-on-docker><span>The Arm Adventure on Docker</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210908travelogue-li><a href=/blog/2021/09/08/travelogue/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210908travelogue><span>Travelogue</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210811announcing-findy-agency-li><a href=/blog/2021/08/11/announcing-findy-agency/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210811announcing-findy-agency><span>Announcing Findy Agency</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a id=print href=/blog/_print/><i class="fa-solid fa-print fa-fw"></i> Print entire section</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#abstraction-layers>Abstraction Layers</a></li><li><a href=#concurrency-ne-parallelism>Concurrency \(\ne\) Parallelism</a></li><li><a href=#fsm----state-of-the-art>FSM &ndash; State-Of-The-Art</a><ul><li><a href=#scxml>SCXML</a></li><li><a href=#lua>Lua</a></li><li><a href=#yaml>YAML</a></li></ul></li><li><a href=#the-event-processor>The Event Processor</a></li><li><a href=#services-and-conversations>Services and Conversations</a></li><li><a href=#csp--go-code>CSP & Go Code</a><ul><li><a href=#discrete-state-transitions>Discrete State Transitions</a></li><li><a href=#channels-orchestrate-mutexes-serialize>&ldquo;Channels orchestrate; mutexes serialize&rdquo;</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><a class=td-rss-button title=RSS href=/blog/index.xml target=_blank rel=noopener><i class="fa-solid fa-rss" aria-hidden=true></i></a><div class=td-content><h1>Beautiful State-Machines - FSM Part II</h1><div class=lead>In today’s software development landscape, efficient and robust state management systems are more critical than ever. Finite state machines (FSMs), together with Go’s Communicating Sequential Processes (CSP) concurrency mechanism, we can provide a robust and elegant approach to modeling and controlling complex systems with discrete states and transitions.</div><div class="td-byline mb-4">By <b>Harri Lainio</b> |
<time datetime=2023-06-22 class=text-muted>Thursday, June 22, 2023</time></div><header class=article-meta></header><p>As I explained in <a href=https://findy-network.github.io/blog/2023/03/13/no-code-ssi-chatbots-fsm-part-i/>my previous blog
post</a>,
the idea of chatbots came quite naturally for our SSI development team. Think
tanks or research labs are outstanding workplaces when you have something to chew.
And how juicy topic the SSI has been, oh boy.</p><p>FSM chatbots started as a thought experiment, but now, when I think of the
invention, it has been quite clever in foreseeing genuine user needs. It has
lead us towards the following layer model.</p><figure class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:2563px><img class=card-img-top src=/blog/2023/06/22/beautiful-state-machines-fsm-part-ii/layers_huc401822c3d0db0f1b03a6299777b88f3_2353012_2553x0_resize_catmullrom_3.png width=2553 height=1377><figcaption class="card-body px-0 pt-2 pb-0"><p class=card-text><em>Network Layers For SSI Are Clarifying Themselves</em></p></figcaption></figure><p>The preceding drawing presents our ongoing layer architecture. It&rsquo;s (still)
based on DIDComm, but because our protocol engine implements a
technology-agnostic API, we can change the implementation to something better
without disturbing the above layers. The subject of this blog post is <strong>our FSM
engine&rsquo;s</strong> (<em>3rd layer from bottom</em>) CSP implementation that offers even more
abstraction and helps the application development with <a href=https://findy-network.github.io/blog/2023/03/13/no-code-ssi-chatbots-fsm-part-i/#the-fsm-language>no-code chatbot
language</a>.</p><h2 id=abstraction-layers>Abstraction Layers</h2><p>Implementing the FSM chatbots with our protocol-agnostic API has been
eye-opening. With our API, we have solved most of the complexity problems and
brought in an elegant communication layer that hides most of the horror of DID
system, which, by to way, is not application development ready.</p><p>The objective of this blog post is to present a comprehensive exploration of my
Go-based finite state-machine implementation that leverages Go&rsquo;s CSP concurrency
mechanism. This post will showcase the practical applications and benefits of
using Go and CSP in building reliable and concurrent state management systems.</p><h2 id=concurrency-ne-parallelism>Concurrency \(\ne\) Parallelism</h2><p>I have been using multithreading programming all my career and closely
monitoring paradigms of multithreading programming since the 90s. When I started
playing with Go’s channels and <a href=https://en.wikipedia.org/wiki/Communicating_sequential_processes>CSP programming
model</a>, I
learned how easy it was compared to other asynchronous or multithreading
programming models.</p><figure class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:473px><img class=card-img-top src=/blog/2023/06/22/beautiful-state-machines-fsm-part-ii/interrupt_hu136a998f0a715f31af0676e8582771a1_34484_463x0_resize_q75_catmullrom.jpg width=463 height=410><figcaption class="card-body px-0 pt-2 pb-0"><p class=card-text><em>Interrupt Based Scheduling -- Mark Siegesmund, in Embedded C Programming, 2014</em></p></figcaption></figure><p>If I look at the phases I have gone thru, they follow these steps harshly:</p><ol><li>Using interrupts to achieve concurrency. (<em>MS-DOS drivers and
<a href=https://en.wikipedia.org/wiki/Terminate-and-stay-resident_program>TSRs</a>,
modem-based distributed systems, games, etc.</em>)</li><li>Using the event-driven system to achieve concurrency. (<em>Game development, GUI
OS Win&amp;Mac, transport-agnostic, i.e., modems, <a href=https://people.ece.ubc.ca/gillies/pages/9802net.html>proprietary protocols for
interconnection</a>,
<a href=https://tangentsoft.com/wskfaq/articles/history.html>Winsocks</a> file
transport framework, etc.</em>)</li><li>Using OS and HW threads to achieve concurrency. (<em>Unix daemon and Win
NT service programming, C/S transport framework implementations, telehealth
system implementation, etc.</em>)</li><li>Sharing workloads between CPU and GPU to achieve maximum parallel execution.
(<em>The front/back-buffer synchronization, i.e., <a href=https://algorithm-wiki.csail.mit.edu/wiki/Culling>culling
algorithms</a> and
<a href=https://en.wikipedia.org/wiki/Level_of_detail_(computer_graphics)>LOD</a> are
running simultaneously in a CPU during the GPU is rendering the polygons of
the previous frame, etc.</em>)</li><li>Using libraries and frameworks
(<a href=https://developer.apple.com/documentation/swift/task>tasks</a>, work queues,
<a href=https://en.wikipedia.org/wiki/Actor_model>actor model</a>, etc.) to
achieve parallel execution for performance reasons. (<em>Using
<a href=https://learn.microsoft.com/en-us/dotnet/standard/parallel-programming/task-parallel-library-tpl>TPL</a>
to instantiation (i.e., common transformation matrix) pipeline for tessellated
graphic units, etc.</em>)</li><li>Using frameworks to bring parallel execution to the application level,
wondering why the industry starts taking steps back and prefers asynchronous
programming models over, for example, worker threads. One answer: keep
everything in the main thread. (<em>iOS [recommended] network programming, Dart
language, node.js, etc.</em>)</li><li>Using CSP to hide HW details and still achieve a speedup of parallel execution,
but only if it&rsquo;s used correctly. (<em>Example: Input routine -> Processing -> Output
routine -pattern to remove blocking IO waits, etc.</em>)</li></ol><p>As you can see, distributed computing goes hand in hand with concurrency. And
now distributed systems are more critical than ever.</p><p>And what goes around comes around. Now we&rsquo;re using a <a href=https://github.com/golang/go/issues/51071#issuecomment-1033108591>hybrid
model</a> where
the scheduler combines OS threads (preemptive multitasking) and cooperative
event handling. But like everything in performance optimization, this model
isn&rsquo;t the fastest or <a href=https://go.dev/blog/waza-talk>doesn&rsquo;t give you the best possible
parallelization</a> results for every algorithm. But
it seems to provide enough, and it offers a simple and elegant programming model
that almost all developers can reason with.</p><blockquote><p>Note. Go offers <a href=https://pkg.go.dev/runtime#LockOSThread><code>runtime.LockOSThread</code>
function</a> if you want to maximize
parallelization by allocating an OS thread for a job.</p></blockquote><h2 id=fsm----state-of-the-art>FSM &ndash; State-Of-The-Art</h2><p>Previous technology spikes have proven that state machines would be the right
way to go, but I would need to try it with, should I say, complete state
machines. And that was our hypothesis: <em>FSM perfectly matches SSI and
DIDComm-based chatbots</em>.</p><p>One of my design principles has always been that never create a new language,
always use an existing one. So, I tried to search for proper candidates, and I
did find a few.</p><h3 id=scxml>SCXML</h3><p>The most promising and exciting one was
<a href=https://www.w3.org/TR/scxml/>SCXML</a>, but I didn&rsquo;t find a suitable embedded
engine to run these machines, especially as an open-source. Nevertheless, very
interesting <a href=https://blogs.itemis.com/en/how-to-create-robust-system-models-with-yakindu-statechart-tools-and-verification-tools>commercial high-end
tools</a>
supported
<a href=https://en.wikipedia.org/wiki/Correctness_(computer_science)>correctness</a>
verification using <a href=https://en.wikipedia.org/wiki/Proof_theory>proving theorems</a>.</p><h3 id=lua>Lua</h3><p>During these state-machine language searches, I discovered <a href=https://github.com/Shopify/go-lua>a Go-native
implementation of Lua</a>, which was
open-source. Naturally, I considered using embedded Lua&rsquo;s model of
states. But I realized that some event engine would be needed, and it
would have brought at least the following challenges:</p><ol><li>Whole new API and bridge to Aries protocols would be needed. A simple C/S API
wouldn&rsquo;t be enough, but a notification system would also be required.</li><li>Lua is a Turing-complete language (correctness guarantees, the halting
problem, etc.)</li><li>And final question: what extra would we be brought in when compared to
offering Lua stubs to our current gRPC API, i.e., Lua would be treated the
same as all the other languages that gRPC supports?</li></ol><h3 id=yaml>YAML</h3><p>I soon discovered that YAML might be an excellent language for FSM because it’s
proven to work for <a href=https://en.wikipedia.org/wiki/Declarative_programming>declarative
solutions</a> like container
orchestration and many cloud frameworks.</p><p>Naturally, I tried to search OSS solution that would be based on YAML and would
offer a way to implement a state-machines event processor. Unfortunately, I
didn’t find a match, so we made our hybrid by offering two languages, YAML and
Lua.</p><p>Lua is now included as an embedded scripting language <em>for
our FSM</em>. It can be used to <a href=https://findy-network.github.io/blog/2023/03/13/no-code-ssi-chatbots-fsm-part-i/#event>implement custom
triggers</a>
and custom output events.</p><p>You can write Lua directly to YAML files or include a file link and write Lua
scripts to external files. (<em>Depending on the deployment model, that could be
a security problem, but we are in an early stage of the technology. Our
deployment model is closed. The final step to solve all security problems
related to deployment and injection is when we have an integrated correctness
tool.</em>)</p><h2 id=the-event-processor>The Event Processor</h2><p>Our FSM engine follows the exact same principle as <a href=https://en.wikipedia.org/wiki/SCXML>the SCXML processor</a> does:</p><blockquote><p>An SCXML processor is a pure event processor. The only way to get data into an
SCXML state machine is to send external events to it. The only way to get data
out is to receive events from it.</p></blockquote><p>In the software industry, there are some other similar systems, like, for example,
<a href=https://ebpf.io/>eBPF</a>, where correctness is provided without formal language.
eBPF automatically <strong>rejects programs without strong exit guarantees</strong>, i.e.,
for/while loops without exit conditions. That&rsquo;s achieved with static code
analysis, which allows using conventional programming languages.</p><p>Now that <em>we have brought Lua-scripting into our FSMs</em>, we should also get
<em>code analysis for the exit guarantees</em>, but let&rsquo;s first figure out how
good a fit it is. My first impressions have been excellent.</p><h2 id=services-and-conversations>Services and Conversations</h2><p>The drawing below includes our multi-tenant model. FSM instances and their
memory containers are on the right-hand side of the diagram. The smaller ones
are conversation instances that hold the state of each pairwise connection
status. The larger one is <em>the service state machine</em>.</p><figure class="card rounded p-2 td-post-card mb-4 mt-4" style=max-width:1640px><img class=card-img-top src=/blog/2023/06/22/beautiful-state-machines-fsm-part-ii/cover-logical_hu3cc2cb8ee146ca056e4d93ad4b3d07f3_957927_1630x0_resize_catmullrom_3.png width=1630 height=1111><figcaption class="card-body px-0 pt-2 pb-0"><p class=card-text><em>Two Tier Multi-tenancy</em></p></figcaption></figure><p>The service FSM is needed if the SSI agent implements a chatbot that needs to keep
track of all of the conversations like polling, voting, <strong>chat rooms</strong> (used as
an example), etc.</p><pre tabindex=0><code class=language-plantuml data-lang=plantuml>title Chat Room Example

actor &#34;Dude&#34; as Dude
participant &#34;Dude&#34; as ChatUI  &lt;&lt;chat UI&gt;&gt;
collections &#34;Dudes&#34; as ReadUI  &lt;&lt;read UI&gt;&gt;
collections &#34;Conversation Bots&#34; as PWBot &lt;&lt;pairwise FSM&gt;&gt;
control &#34;Chat Room Service Bot&#34; as Backend

== A Dude writes line ==
Dude -&gt; ChatUI: Yo!

ChatUI -&gt; PWBot: BasicMessage{&#34;Yo!&#34;}
|||
== Conversation FSM forwards msg to service FSM ==
PWBot -&gt; Backend: BackendMsg{&#34;Yo!&#34;}
loop conversation count
   Backend -&gt; PWBot: BackendMsg{&#34;Yo!&#34;}
== transport message thru pairwise connection ==
   PWBot -&gt; ReadUI: BasicMessage{&#34;Yo!&#34;}
end
|||
</code></pre><p>As the sequence diagram above shows, the service FSM conceptually presents a
chat room and works as a mediator between chat room participants.</p><p>The next Go code block shows how the above FSM instances are declared at the
programming level. Note that <code>ServiceFSM</code> is optional and seldom needed. The
rest of the data is pretty obvious:</p><ul><li>gRPC connection, <code>conn</code></li><li>conversation FSM, <code>md</code></li><li>and interrupt channel is given as a startup argument, <code>intCh</code>, because here,
the machine is started from the CLI tool</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#000>intCh</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87>make</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>chan</span> <span style=color:#000>os</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Signal</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#000>signal</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Notify</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>intCh</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>syscall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SIGTERM</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>syscall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SIGINT</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000>chat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Bot</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#000>Conn</span><span style=color:#000;font-weight:700>:</span>        <span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span>      <span style=color:#8f5902;font-style:italic>// gRPC connection including JWT, etc.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>MachineData</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>md</span><span style=color:#000;font-weight:700>,</span>        <span style=color:#8f5902;font-style:italic>// primary FSM data, i.e. pairwise lvl
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>ServiceFSM</span><span style=color:#000;font-weight:700>:</span>  <span style=color:#000>mdService</span><span style=color:#000;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>// optional backend/service lvl FSM
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000;font-weight:700>}.</span><span style=color:#000>Run</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>intCh</span><span style=color:#000;font-weight:700>)</span>                <span style=color:#8f5902;font-style:italic>// let machine to know when it&#39;s time to quit
</span></span></span></code></pre></div><p>By utilizing the CSP model, we embrace a paradigm that emphasizes the
coordination and communication between independently executing components, known
as goroutines, in a safe and efficient manner. This combination of Go&rsquo;s
built-in concurrency primitives empowers us developers to create highly
concurrent systems while maintaining clarity and simplicity in their code.</p><h2 id=csp--go-code>CSP & Go Code</h2><p>The app logic is in the state machines written in YAML and Lua. But
surprising is how elegant the Go implementation can be when CSP is
used for the state-machine processor. And all of that without a single mutex or
other synchronization object.</p><p>The code block below is the crucial component of the FSM engine solution. It is
presented as it currently is in the code repo, because I want to show honestly
how simple the implementation is. Even the all lines aren&rsquo;t relevant for
this post. They are left for you to study and understand how powerful the CSP
model for concurrency is.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>Multiplexer</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>info</span> <span style=color:#000>MultiplexerInfo</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#000>glog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>V</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>Infoln</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;starting multiplexer&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>info</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ConversationMachine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>FType</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#000>termChan</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87>make</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fsm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TerminateChan</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>backendChan</span> <span style=color:#000>fsm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BackendInChan</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>info</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BackendMachine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>IsValid</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>newBackendService</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>		<span style=color:#000>backendChan</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BackendChan</span>
</span></span><span style=display:flex><span>		<span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>machine</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>fsm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewMachine</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>info</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BackendMachine</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>		<span style=color:#000>try</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>To</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>machine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Initialize</span><span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span>		<span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>machine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>InitLua</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#000>glog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>V</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>Infoln</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;starting and send first step:&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>info</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BackendMachine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>FType</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>		<span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>send</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>machine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Start</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fsm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TerminateOutChan</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TerminateChan</span><span style=color:#000;font-weight:700>)))</span>
</span></span><span style=display:flex><span>		<span style=color:#000>glog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>V</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>Infoln</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;going to for loop:&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>info</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BackendMachine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>FType</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>select</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#8f5902;font-style:italic>// NOTE. It&#39;s OK to listen nil channel in select.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>backendChan</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>			<span style=color:#000>backendMachine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>backendReceived</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>d</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>ConversationBackendChan</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>			<span style=color:#000>c</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alreadyExists</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>conversations</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>d</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ToConnID</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>			<span style=color:#000>assert</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>That</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>alreadyExists</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;backend msgs to existing conversations only&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>			<span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BackendChan</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>d</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>			<span style=color:#000>connID</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>t</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Notification</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ConnectionID</span>
</span></span><span style=display:flex><span>			<span style=color:#000>c</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alreadyExists</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>conversations</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>connID</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>alreadyExists</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>				<span style=color:#000>c</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>newConversation</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>info</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>connID</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>termChan</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>			<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>			<span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StatusChan</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>t</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>question</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>Question</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>			<span style=color:#000>connID</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>question</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Notification</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ConnectionID</span>
</span></span><span style=display:flex><span>			<span style=color:#000>c</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alreadyExists</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>conversations</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>connID</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>alreadyExists</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>				<span style=color:#000>c</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>newConversation</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>info</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>connID</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>termChan</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>			<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>			<span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>QuestionChan</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>question</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>termChan</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>			<span style=color:#8f5902;font-style:italic>// One machine has reached its terminate state. Let&#39;s signal
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#8f5902;font-style:italic>// outside that the whole system is ready to stop.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>info</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>InterruptCh</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>syscall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SIGTERM</span>
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>It runs in its goroutine and serves all the input and output at the process
level. For those who come from traditional multi-thread programming, this might
look weird. You might ask why a lock doesn&rsquo;t make <code>conversations</code> map thread-safe.
That&rsquo;s the beauty of the CSP. Only this goroutine modifies <code>conversations</code>
data—no one else.</p><p>You might ask if there&rsquo;s a performance penalty in this specific solution, but
there is not. The <code>Multiplexer</code> function doesn&rsquo;t do anything that&rsquo;s
computationally extensive. It listens to several Go channels and delegates the
work to other goroutines.</p><p>This model has proven to be easy to understand and implement.</p><h3 id=discrete-state-transitions>Discrete State Transitions</h3><p>As we saw, the <code>Multiplexer</code> function calls a function below, <code>backendReceived</code>,
when <code>data</code> arrives from <code>backendChan</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Backend</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>backendReceived</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>fsm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BackendData</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>transition</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>machine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TriggersByBackendData</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>transition</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>send</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>transition</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BuildSendEventsFromBackendData</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>		<span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>machine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Step</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>transition</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Both state-machine types (conversation/service level) follow typical transition
logic:</p><ol><li>Do we have a trigger in the current state of the machine?</li><li>If the trigger exists, we&rsquo;ll get a transition object for that.</li><li>Ask the <code>transition</code> to build all send events according to input data.</li><li>Send all output events.</li><li>If previous steps did succeed, make a state transition step explicit.</li></ol><h3 id=channels-orchestrate-mutexes-serialize>&ldquo;Channels orchestrate; mutexes serialize&rdquo;</h3><p>I&rsquo;m not a massive fan of the <a href=https://dave.cheney.net/2020/02/23/the-zen-of-go>idiomatic
Go</a> or <a href=https://go-proverbs.github.io/>Go
proverbs</a>. My point is that you shouldn&rsquo;t
need them. The underlying semantics should be strong enough.</p><p>Luckily the world isn&rsquo;t black and white. So, let&rsquo;s use one proverb to state
something quite obvious.</p><blockquote><p>&ldquo;Channels orchestrate; mutexes serialize&rdquo;</p></blockquote><p>That includes excellent wisdom because it isn&rsquo;t prohibiting you from using the
mutexes. It clearly states that we need both, but they are used differently.
That said, the below code block shows the <em>elegance</em> you can achieve with Go
channels.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Conversation</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Run</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span> <span style=color:#000>fsm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MachineData</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>machine</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>fsm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewMachine</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>	<span style=color:#000>try</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>To</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>machine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Initialize</span><span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span>	<span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>machine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>InitLua</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>	<span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>send</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>machine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Start</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fsm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TerminateOutChan</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TerminateChan</span><span style=color:#000;font-weight:700>)),</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>select</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StatusChan</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>			<span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>statusReceived</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>QuestionChan</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>			<span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>questionReceived</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>hookData</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>HookChan</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>			<span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>hookReceived</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>hookData</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>backendData</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BackendChan</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>			<span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>backendReceived</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>backendData</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>If you have never seen a code mess where a programmer has tried to solve a
concurrence task by only having common control flow statements like if-else,
attempt to envision an amateur cook that tries to make at least four dishes
simultaneously with poor multitasking capabilities. He has to follow recipes
literally for every dish from several cookbooks. I think then you get the
picture.</p><h2 id=conclusion>Conclusion</h2><p>I hope I have shown you how well FSM and CSP fit together. Maybe I even
encouraged you to agree that SSI needs <a href=http://findy-network.github.io/blog/2022/03/05/the-missing-network-layer-model/>better abstraction
layers</a>
before we can start full-scale application development. If you agree we&rsquo;re
on the right path, please join and start coding with us!</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2023/06/13/the-agency-workshop/ aria-label="Previous - The Agency Workshop" class="btn btn-primary"><span class=mr-1>←</span>Previous</a></li><li><a href=/blog/2023/08/23/gophercon-uk-2023/ aria-label="Next - GopherCon UK 2023" class="btn btn-primary">Next<span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/findy-network aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Findy Agency Authors All Rights Reserved</small><p class=mt-2><a href=/about/>About Findy Agency</a></p></div></div></div></footer></div><script src=/js/deflate.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.css integrity="sha512-6VMVcy7XQNyarhVuiL50FzpgCFKsyTd6YO93aaQEyET+BNaWvj0IgKR86Bf6+AmWczxAcSnL+JGjo+iStgO1gQ==" crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.js integrity="sha512-b9IKj4LCNrtCPBhceRcoYOHWW/S2q9fpl7iAJlyxYpykRj1SKM7FE9+E0NEnJ8g8ni47LBr2GuX9qzg/xeuwzQ==" crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/contrib/auto-render.min.js integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg==" crossorigin=anonymous onload=renderMathInElement(document.body,null)></script><script src=https://cdn.jsdelivr.net/npm/mermaid@9.2.2/dist/mermaid.min.js integrity="sha512-IX+bU+wShHqfqaMHLMrtwi4nK6W/Z+QdZoL4kPNtRxI2wCLyHPMAdl3a43Fv1Foqv4AP+aiW6hg1dcrTt3xc+Q==" crossorigin=anonymous></script>
<script src=/js/main.min.5f9fb113d757687f050fa88e558cf3550134dff65d578b2a707553d35161ea6a.js integrity="sha256-X5+xE9dXaH8FD6iOVYzzVQE03/ZdV4sqcHVT01Fh6mo=" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script></body></html>